version: 2.1

executors:
  base:
#    docker:
    machine: true
#      - image: ubuntu-2004:202010-01
#      - image: cimg/base:stable

parameters:
  build-parent:
    type: boolean
    default: false
#  project-two:
#    type: boolean
#    default: false
#  project-three:
#    type: boolean
#    default: false
#  run-them-all:
#    type: boolean
#    default: false
    
jobs:
  build-parent:
      executor: base
      steps:
        - checkout
        - run:
            name: Docker login
            command: |
              docker run --rm -it -e AWS_ACCESS_KEY_ID=$ACCESS_KEY_ID_ENV_VAR_NAME \
              -e AWS_SECRET_ACCESS_KEY=$SECRET_ACCESS_KEY_ENV_VAR_NAME \
              -e AWS_DEFAULT_REGION=$AWS_REGION_ENV_VAR_NAME \
              amazon/aws-cli ecr get-login-password --region $AWS_REGION_ENV_VAR_NAME | cut -c 5- | docker login \
              --username AWS --password-stdin ${AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME}
        - run:
            name: Docker build parent
            command: |
              pwd && ls -lah
              cd Nginx && ls -lah
              docker build -t nginx:parent -f Dockerfile_parent .
        - run:
            name: Docker Image check
            command: docker image ls
        - run:
            name: push to ecr
            command: |
              docker tag nginx:parent $AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME/nginx_parent:$(echo $CIRCLE_SHA1 | cut -c -8)
              docker push $AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME/nginx_parent:$(echo $CIRCLE_SHA1 | cut -c -8)
              docker tag nginx:parent $AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME/nginx_parent:latest
              docker push $AWS_ECR_ACCOUNT_URL_ENV_VAR_NAME/nginx_parent:latest
              
#  project_two: 
#      executor: base
#      steps:
#        - run: 
#            command: |
#              echo "project two" 
#  project_three: 
#      executor: base
#      steps:
#        - run: 
#            command: |
#              echo "project three"
#  all_projects: 
#      executor: base
#      steps:
#        - run: 
#            command: |
#              echo "all"   
              
workflows:
  build-parent:
    when: 
      or: 
        - << pipeline.parameters.build-parent >>
#        - << pipeline.parameters.run-them-all >> 
    jobs:
      - build-parent
      
#  build-2:
#    when: 
#      or: 
#        - << pipeline.parameters.project-two >>
##        - << pipeline.parameters.run-them-all >>     
#    jobs:
#      - project_two
      
#  build-3:
#    when: 
#      or: 
#        - << pipeline.parameters.project-three >>
##        - << pipeline.parameters.run-them-all >> 
#    jobs:
#      - project_three
      
#  build-shared-other:
#    when: << pipeline.parameters.run-them-all >>
#    jobs:
#      - all_projects
